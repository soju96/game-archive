version: '3.7'

services:
  flask:
    build:
      context: .
      dockerfile: dockerfile
    ports:
      - '5000:5000'  # 호스트의 5000 포트를 Flask 컨테이너의 5000 포트에 매핑
    environment:
      - SQLALCHEMY_DATABASE_URI=mysql+pymysql://admin:admin@mysql/flask_db
      - FLASK_ENV=development
    networks:
      - nfs-network
    depends_on:
      - mysql
      - nfs-server
    
  nfs-server:
    image: itsthenetwork/nfs-server-alpine  # NFS server image
    container_name: nfs-server
    environment:
      - SHARED_DIRECTORY=/mnt/nfs_share  # Path to the directory to be shared
    volumes:
      - nfs-data:/mnt/nfs_share           # Local path to share with MySQL container
    ports:
      - "2050:2050"                      # NFS port
    command: /bin/sh -c "mkdir -p /mnt/nfs_share && /usr/sbin/rpcbind && /usr/sbin/nfsd -N 2 && /usr/sbin/rpc.mountd"

  mysql:
    image: sh330400/mysql8:1.0.1
    ports:
      - "3306:3306"  # 호스트의 3306 포트를 컨테이너의 3306 포트에 매핑
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: admin # Set the MySQL root password
      MYSQL_DATABASE: flask_db
      MYSQL_USER: admin
      MYSQL_PASSWORD: admin
    volumes:
      - nfs-data:/var/lib/mysql  # Mount NFS volume as MySQL data directory
    networks:
      - nfs-network

volumes:
  nfs-data:
    driver: local  # Local volume to mount from NFS server

networks:
  nfs-network:
    driver: bridge