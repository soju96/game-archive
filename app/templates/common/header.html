<!-- templates/header.html -->
<div class="page-wrap">
    <header class="custom-navbar">
        <div class="custom-navbar-contents">
            
                <!-- 로고 영역 -->
                <div class="header-box">
                    <div class="brand">
                        <div class="brand-title">
                            <a href="{{ url_for('main.index') }}">
                                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="GAMCAVE Logo" class="site-logo">
                                Game-Archive 
                                    <span>Soldesk 803 Game Community</span>
                            </a>
                            </div>
                    </div>
                </div>

                <div class="header-box">

                    <!-- 네비게이션 영역 -->
                    <nav class="custom-nav-menu">
                        <a href="{{ url_for('ksj.index') }}" class="custom-nav-link">Deals & Discounts</a>
                        <a href="{{ url_for('ssm.index') }}" class="custom-nav-link">Tips & Guides</a>
                        <a href="{{ url_for('csm.index') }}" class="custom-nav-link">Game News</a>
                        <a href="{{ url_for('hyl.qna') }}" class="custom-nav-link" id="qnaLink">Q&A Corner</a>
                    </nav>
                </div>

                <div class="header-box">
                    <!-- 로그인 여부 확인 -->
                    {% if not session.get('user_id') %}
                        <!-- 로그인 및 회원가입 버튼 (비로그인 상태) -->
                        <div class="custom-nav-right buttons">
                            <button class="navbtn" id="loginButton" data-url="{{ url_for('hjw.index') }}">
                                Login
                            </button>
                        </div>
                        <div class="custom-nav-right buttons">
                            <button class="navbtn" id="signupButton" data-url="{{ url_for('hjw.signup') }}">
                                Sign Up
                            </button>
                        </div>
                    {% else %}
                        <!-- 로그아웃 버튼 (로그인 상태) -->
                        <div class="custom-nav-right buttons">
                            <form action="{{ url_for('hjw.logout') }}" method="POST">
                                <button type="submit" class="navbtn">
                                    Logout
                                </button>
                            </form>
                        </div>
                    {% endif %}
                </div>

                <!-- 햄버거 메뉴 -->
                <div class="hamburger-menu" id="hamburgerMenu">
                    <button id="hamburger-menuToggle" class="hamburger-menu-btn">☰</button>
                    <div class="hamburger-dropdown-menu hidden" id="hamburger-dropdownMenu">
                        <a href="{{ url_for('ksj.index') }}">Deals & Discounts</a>
                        <a href="{{ url_for('ssm.index') }}">Tips & Guides</a>
                        <a href="{{ url_for('csm.index') }}">Game News</a>
                        <a href="{{ url_for('hyl.qna') }}">Q&A Corner</a>
                        <hr> <!-- 구분선 -->
                        <a href="{{ url_for('hjw.index') }}">Login</a>
                        <a href="{{ url_for('hjw.signup') }}">Sign up</a>
                    </div>
                </div>
        </div>
    </header>

    <main>

    <!-- 타임딜 홍보 영역 -->
    <a href="{{ url_for('ksj.timedeal') }}" class="time-deal-link">
        
        <section class="time-deal-section">
            <img src="{{ url_for('static', filename='images/main-hyl.jpg') }}" alt="Time Deal Background" class="time-deal-image">
            <div class="center-content center-text">
                <div class="tag-flex">
                    <div class="custom-title" id="subtitle">
                    </div>
                </div>
                <h1 class="large-heading" id="typewriter"></h1>
    
                <p class="reset-time">
                    Coupons reset at: {{ reset_time }}
                </p>
            </div>
        </section>
        
    </a>
    <!-- 검색창 영역 -->
    <div class="search-filter-section">
    <!-- 검색창과 필터 아이콘 -->
    <div class="search-bar-container">
        <input type="text" class="search-bar" placeholder="Search for guides, posts, and more...">
        <button class="search-button">Search</button>
    </div>

     </div>
     
     </main>
 </div>

 <script>
    document.getElementById('qnaLink').addEventListener('click', async function(event) {
        event.preventDefault();  // 기본 동작을 막습니다.

        // 로그인 여부를 먼저 확인합니다.
        var isLoggedIn = "{{ session.get('user_id') is not none }}";

        if (isLoggedIn === "False") {
            // 로그인되어 있지 않은 경우 알림창을 띄우고 로그인 페이지로 이동합니다.
            alert("로그인이 필요합니다. 로그인 페이지로 이동합니다.");
            window.location.href = "{{ url_for('hjw.index') }}";
        } else {
            try {
                // Q&A 페이지 접근 시도
                let response = await fetch("{{ url_for('hyl.qna') }}", {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.status === 401) {
                    // Access Token이 만료된 경우 Refresh Token을 사용하여 새로운 Access Token 발급 요청
                    let refreshResponse = await fetch("{{ url_for('hjw.refresh') }}", {
                        method: 'POST',
                        credentials: 'same-origin'
                    });

                    if (refreshResponse.ok) {
                        // 새로운 Access Token 발급 성공 시, 다시 Q&A 페이지 접근 시도
                        response = await fetch("{{ url_for('hyl.qna') }}", {
                            method: 'GET',
                            credentials: 'same-origin'
                        });

                        if (response.ok) {
                            window.location.href = "{{ url_for('hyl.qna') }}";
                        } else {
                            alert("페이지에 접근할 수 없습니다. 다시 로그인해 주세요.");
                            window.location.href = "{{ url_for('hjw.index') }}";
                        }
                    } else {
                        // Refresh Token도 유효하지 않은 경우 명시적으로 로그아웃 처리
                        await fetch("{{ url_for('hjw.logout') }}", {
                            method: 'POST',
                            credentials: 'same-origin'
                        });

                        alert("세션이 만료되었습니다. 다시 로그인해 주세요.");
                        window.location.href = "{{ url_for('hjw.index') }}";
                    }
                } else if (response.ok) {
                    // 토큰이 유효하다면 Q&A 페이지로 이동
                    window.location.href = "{{ url_for('hyl.qna') }}";
                } else {
                    alert("오류가 발생했습니다. 다시 로그인해 주세요.");
                    window.location.href = "{{ url_for('hjw.index') }}";
                }
            } catch (error) {
                console.error('오류가 발생했습니다.', error);
                alert("네트워크 오류가 발생했습니다. 다시 시도해주세요.");
            }
        }
    });
</script>